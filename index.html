<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi-Mode AI Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        /* ORIGINAL CSS RESTORED & OPTIMIZED FOR LAYOUT */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-color: #ffffff;
            --accent-glow: 0 0 20px rgba(102, 126, 234, 0.5);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
            overflow-x: hidden;
            transition: background 0.8s ease;
        }

        /* Notification Container */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            max-width: 90%; /* Mobile fix */
        }

        .notification {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 15px;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: translateX(400px);
            opacity: 0;
            animation: slideInNotification 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            pointer-events: all;
            min-width: 300px;
            width: 100%; /* Mobile fix */
        }

        .notification.exit {
            animation: slideOutNotification 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes slideInNotification {
            0% { transform: translateX(400px) scale(0.5); opacity: 0; }
            50% { transform: translateX(-20px) scale(1.05); }
            100% { transform: translateX(0) scale(1); opacity: 1; }
        }

        @keyframes slideOutNotification {
            0% { transform: translateX(0) scale(1); opacity: 1; }
            100% { transform: translateX(400px) scale(0.5); opacity: 0; }
        }

        .notification-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            animation: notificationPulse 1s ease-in-out infinite;
            position: relative;
            flex-shrink: 0; /* Prevent squishing */
        }

        .notification-icon::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: notificationRing 1s ease-out infinite;
        }

        @keyframes notificationPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes notificationRing {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .notification-content { flex: 1; }
        .notification-title { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.9rem; margin-bottom: 3px; }
        .notification-message { font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 0 0 15px 15px;
            animation: notificationProgress 4s linear forwards;
        }

        @keyframes notificationProgress {
            0% { width: 100%; }
            100% { width: 0%; }
        }

        .notification-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            padding: 5px;
        }

        .notification-close:hover {
            color: white;
            transform: rotate(90deg);
        }

        /* Animated Background Particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 50%;
            opacity: 0.3;
            animation: float 15s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.3; }
            90% { opacity: 0.3; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        /* Floating Shapes */
        .floating-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .shape {
            position: absolute;
            opacity: 0.1;
            animation: floatShape 20s infinite ease-in-out;
        }

        .shape.circle {
            width: 100px;
            height: 100px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
        }

        .shape.square {
            width: 80px;
            height: 80px;
            border: 2px solid var(--secondary-color);
            transform: rotate(45deg);
        }

        .shape.triangle {
            width: 0;
            height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-bottom: 86px solid var(--primary-color);
            opacity: 0.05;
        }

        @keyframes floatShape {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(50px, -50px) rotate(90deg); }
            50% { transform: translate(0, -100px) rotate(180deg); }
            75% { transform: translate(-50px, -50px) rotate(270deg); }
        }

        /* Confetti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1500;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            top: -20px;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(0) rotateZ(0deg) rotateY(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotateZ(720deg) rotateY(360deg); opacity: 0; }
        }

        /* Sparkle Effect */
        .sparkle {
            position: absolute;
            width: 20px;
            height: 20px;
            pointer-events: none;
            animation: sparkle 0.8s ease-out forwards;
        }

        .sparkle::before,
        .sparkle::after {
            content: '';
            position: absolute;
            background: white;
        }

        .sparkle::before {
            width: 100%;
            height: 2px;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
        }

        .sparkle::after {
            width: 2px;
            height: 100%;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }

        @keyframes sparkle {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1) rotate(180deg); opacity: 1; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
            /* Layout Fix: Ensure container handles width gracefully */
            width: 100%;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 30px 0;
            position: relative;
        }

        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), #f093fb, var(--primary-color));
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientFlow 5s ease infinite;
            position: relative;
            display: inline-block;
            line-height: 1.2;
        }

        @keyframes gradientFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            animation: lineGlow 2s ease-in-out infinite;
        }

        @keyframes lineGlow {
            0%, 100% { width: 100px; opacity: 0.5; }
            50% { width: 200px; opacity: 1; }
        }

        .header p {
            color: rgba(255, 255, 255, 0.6);
            margin-top: 20px;
            animation: fadeInUp 1s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 50px;
            margin-top: 15px;
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(0, 255, 136, 0.2); }
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            perspective: 1000px;
        }

        .mode-btn {
            padding: 15px 25px;
            border: 2px solid transparent;
            border-radius: 50px;
            background: var(--card-bg);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
            transform-style: preserve-3d;
            white-space: nowrap; /* Prevent text wrapping inside button */
        }

        .mode-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .mode-btn:hover::before {
            left: 100%;
        }

        .mode-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50px;
            padding: 2px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color), var(--primary-color));
            background-size: 200% 200%;
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s ease;
            animation: borderRotate 3s linear infinite;
        }

        @keyframes borderRotate {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .mode-btn:hover::after {
            opacity: 1;
        }

        .mode-btn:hover {
            transform: translateY(-5px) scale(1.05) rotateX(10deg);
            box-shadow: var(--accent-glow), 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .mode-btn.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
            animation: activeButtonPulse 2s ease-in-out infinite;
        }

        @keyframes activeButtonPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 50px rgba(102, 126, 234, 0.6), 0 0 80px rgba(102, 126, 234, 0.3); }
        }

        .mode-btn i {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .mode-btn:hover i {
            transform: rotate(360deg) scale(1.2);
        }

        /* Ripple Effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: rippleEffect 0.6s linear;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to { transform: scale(4); opacity: 0; }
        }

        /* Mode Specific Colors */
        .mode-btn[data-mode="image"] { --mode-color: #f093fb; }
        .mode-btn[data-mode="research"] { --mode-color: #4facfe; }
        .mode-btn[data-mode="buddy"] { --mode-color: #43e97b; }
        .mode-btn[data-mode="nerdy"] { --mode-color: #fa709a; }
        .mode-btn[data-mode="bitching"] { --mode-color: #ff6b6b; }

        .mode-btn[data-mode].active {
            border-color: var(--mode-color);
            box-shadow: 0 0 30px color-mix(in srgb, var(--mode-color) 40%, transparent);
        }

        .mode-btn[data-mode]:hover {
            border-color: var(--mode-color);
        }

        /* Transition Overlay */
        .transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .transition-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .transition-content {
            text-align: center;
            position: relative;
        }

        /* Circular Progress */
        .circular-progress {
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
            position: relative;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
        }

        .circular-progress circle {
            fill: none;
            stroke-width: 4;
        }

        .circular-progress .bg {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .circular-progress .progress {
            stroke: url(#gradient);
            stroke-linecap: round;
            stroke-dasharray: 565;
            stroke-dashoffset: 565;
            animation: circularProgress 2s ease-out forwards;
        }

        @keyframes circularProgress {
            to { stroke-dashoffset: 0; }
        }

        .transition-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            animation: iconBounce 1s ease-in-out infinite, iconRotate 3s linear infinite;
        }

        @keyframes iconBounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        @keyframes iconRotate {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .transition-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            margin-bottom: 20px;
            overflow: hidden;
            padding: 0 20px;
        }

        .transition-text span {
            display: inline-block;
            animation: textWave 0.5s ease forwards;
            opacity: 0;
        }

        @keyframes textWave {
            0% { opacity: 0; transform: translateY(20px) rotateX(90deg); }
            100% { opacity: 1; transform: translateY(0) rotateX(0deg); }
        }

        .loading-bar {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 0 auto;
            position: relative;
            max-width: 80%; /* Mobile fix */
        }

        .loading-progress {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--primary-color));
            background-size: 200% 100%;
            border-radius: 3px;
            animation: loadingProgress 2s ease-out forwards, shimmer 1s linear infinite;
        }

        @keyframes loadingProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .status-messages {
            margin-top: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            min-height: 25px;
            animation: fadeInOut 0.5s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        /* Orbit Animation */
        .orbit-container {
            position: absolute;
            width: 300px;
            height: 300px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .orbit {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 1px dashed rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: orbitRotate 10s linear infinite;
        }

        .orbit:nth-child(2) {
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
            animation-duration: 8s;
            animation-direction: reverse;
        }

        .orbit:nth-child(3) {
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
            animation-duration: 6s;
        }

        .orbit-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            border-radius: 50%;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 20px var(--primary-color);
        }

        @keyframes orbitRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Chat Container */
        .chat-container {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            transition: all 0.5s ease, transform 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            /* Layout Fix: Flexible height instead of fixed */
            display: flex;
            flex-direction: column;
            height: 600px; /* Default Desktop Height */
        }

        .chat-container::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            padding: 1px;
            background: linear-gradient(135deg, var(--primary-color), transparent, var(--secondary-color));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            opacity: 0.5;
        }

        .chat-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
        }

        /* Current Mode Display */
        .current-mode-display {
            padding: 20px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .current-mode-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            animation: shineEffect 3s linear infinite;
        }

        @keyframes shineEffect {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .current-mode-display i {
            font-size: 1.5rem;
            animation: iconFloat 2s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .current-mode-display span {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .mode-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 0 0 10px #00ff88;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 10px #00ff88; }
            50% { transform: scale(1.5); box-shadow: 0 0 20px #00ff88; }
        }

        /* Wave Effect */
        .wave-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 30px;
            overflow: hidden;
        }

        .wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 200%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z' fill='rgba(255,255,255,0.05)'/%3E%3C/svg%3E");
            background-size: 1200px 100%;
            animation: wave 15s linear infinite;
        }

        .wave:nth-child(2) {
            bottom: 5px;
            opacity: 0.5;
            animation-duration: 10s;
            animation-direction: reverse;
        }

        @keyframes wave {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1; /* Take remaining height */
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
            position: relative;
            min-height: 200px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .message {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            animation: messageSlide 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateX(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .message.user {
            flex-direction: row-reverse;
            animation-name: messageSlideRight;
        }

        @keyframes messageSlideRight {
            from {
                opacity: 0;
                transform: translateX(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .message-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .message-avatar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: inherit;
            filter: blur(10px);
            opacity: 0.5;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            animation: avatarPulse 2s ease-in-out infinite;
        }

        @keyframes avatarPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(102, 126, 234, 0.2); }
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #43e97b, #38f9d7);
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            backdrop-filter: blur(10px);
            word-wrap: break-word; /* Ensure text wraps on mobile */
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-bottom-right-radius: 5px;
        }

        .message.bot .message-content {
            border-bottom-left-radius: 5px;
        }

        .message-text {
            line-height: 1.6;
        }
        
        /* Math & Markdown Support Overrides */
        .message-text p { margin-bottom: 10px; }
        .katex { font-size: 1.1em !important; }
        .katex-display { overflow-x: auto; overflow-y: hidden; }

        .message-time {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 15px;
            padding: 10px 20px;
        }

        .typing-indicator.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .typing-dots {
            display: flex;
            gap: 5px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Input Area */
        .chat-input-area {
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            min-width: 0; /* Mobile Flex fix */
        }

        .chat-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3), inset 0 0 20px rgba(102, 126, 234, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .send-btn {
            width: 55px;
            height: 55px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .send-btn:hover::before {
            opacity: 1;
        }

        .send-btn i {
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }

        .send-btn:hover i {
            transform: translateX(3px);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap; /* Changed for mobile flow */
            overflow-x: auto;
            /* Hide scrollbar */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .quick-actions::-webkit-scrollbar {
            display: none;
        }

        .quick-action-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            flex: 0 0 auto; /* Keep buttons consistent size */
        }

        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }

        .quick-action-btn:hover::before {
            width: 200%;
            height: 200%;
        }

        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        /* Mode-specific themes */
        body[data-theme="image"] {
            --primary-color: #f093fb;
            --secondary-color: #f5576c;
        }

        body[data-theme="research"] {
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
        }

        body[data-theme="buddy"] {
            --primary-color: #43e97b;
            --secondary-color: #38f9d7;
        }

        body[data-theme="nerdy"] {
            --primary-color: #fa709a;
            --secondary-color: #fee140;
        }

        body[data-theme="bitching"] {
            --primary-color: #ff6b6b;
            --secondary-color: #ffa502;
        }

        /* Feature Tags */
        .feature-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 20px;
            padding: 0 20px 40px 20px; /* Added bottom padding for mobile scroll */
        }

        .feature-tag {
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: tagFloat 3s ease-in-out infinite;
        }

        .feature-tag:nth-child(2) { animation-delay: 0.5s; }
        .feature-tag:nth-child(3) { animation-delay: 1s; }
        .feature-tag:nth-child(4) { animation-delay: 1.5s; }

        @keyframes tagFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Glitch Effect */
        .glitch {
            animation: glitch 0.3s infinite;
        }

        @keyframes glitch {
            0%, 100% { transform: translate(0); filter: hue-rotate(0deg); }
            20% { transform: translate(-3px, 3px); filter: hue-rotate(90deg); }
            40% { transform: translate(-3px, -3px); filter: hue-rotate(180deg); }
            60% { transform: translate(3px, 3px); filter: hue-rotate(270deg); }
            80% { transform: translate(3px, -3px); filter: hue-rotate(360deg); }
        }

        /* Rainbow Effect */
        .rainbow {
            animation: rainbow 2s linear infinite;
        }

        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* Matrix Effect */
        .matrix-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(0deg, transparent 24%, rgba(32, 255, 77, .03) 25%, rgba(32, 255, 77, .03) 26%, transparent 27%, transparent 74%, rgba(32, 255, 77, .03) 75%, rgba(32, 255, 77, .03) 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, rgba(32, 255, 77, .03) 25%, rgba(32, 255, 77, .03) 26%, transparent 27%, transparent 74%, rgba(32, 255, 77, .03) 75%, rgba(32, 255, 77, .03) 76%, transparent 77%, transparent);
            background-size: 50px 50px;
            animation: matrixMove 2s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes matrixMove {
            0% { transform: translateY(0); }
            100% { transform: translateY(50px); }
        }

        /* Shake Animation */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* Emoji Rain */
        .emoji-rain {
            position: fixed;
            font-size: 2rem;
            animation: emojiRain 3s linear forwards;
            pointer-events: none;
            z-index: 1500;
        }

        @keyframes emojiRain {
            0% {
                transform: translateY(-50px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Sound Wave */
        .sound-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }

        .sound-wave span {
            width: 3px;
            background: var(--primary-color);
            border-radius: 2px;
            animation: soundWave 0.5s ease-in-out infinite alternate;
        }

        .sound-wave span:nth-child(1) { height: 30%; animation-delay: 0s; }
        .sound-wave span:nth-child(2) { height: 60%; animation-delay: 0.1s; }
        .sound-wave span:nth-child(3) { height: 100%; animation-delay: 0.2s; }
        .sound-wave span:nth-child(4) { height: 60%; animation-delay: 0.3s; }
        .sound-wave span:nth-child(5) { height: 30%; animation-delay: 0.4s; }

        @keyframes soundWave {
            0% { transform: scaleY(0.5); }
            100% { transform: scaleY(1); }
        }

        /* --- RESPONSIVE OPTIMIZATION --- */
        
        /* Tablets and smaller laptops */
        @media (max-width: 992px) {
            .container { padding: 15px; }
            .header h1 { font-size: 2.2rem; }
            .chat-container { height: 550px; }
        }

        /* Mobile Devices (Portrait) */
        @media (max-width: 768px) {
            .container { padding: 10px; width: 100%; }
            .header { padding: 20px 0; }
            .header h1 { font-size: 1.8rem; }
            .header p { font-size: 0.85rem; }
            
            /* Compact Status */
            .status-badge { 
                margin-top: 10px; 
                padding: 6px 12px; 
                font-size: 0.8rem;
            }

            /* Optimized Mode Buttons Grid for Mobile */
            .mode-selector {
                gap: 8px;
                margin: 15px 0;
                display: grid;
                grid-template-columns: repeat(2, 1fr); /* 2 columns strictly */
            }

            .mode-btn {
                padding: 10px 12px;
                font-size: 0.8rem;
                width: 100%;
                justify-content: center;
            }

            /* Make Chat Full Height on Mobile */
            .chat-container {
                height: calc(100vh - 280px); /* Dynamic height based on viewport */
                min-height: 400px;
                margin-bottom: 0;
            }
            
            .chat-messages {
                padding: 15px;
            }

            /* Compact Input Area */
            .chat-input-area {
                padding: 10px;
            }
            
            .input-wrapper {
                gap: 8px;
            }

            .chat-input {
                padding: 10px 15px;
                font-size: 0.95rem;
            }

            .send-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }

            /* Message Bubbles Optimizations */
            .message { gap: 10px; margin-bottom: 15px; }
            .message-avatar { width: 35px; height: 35px; font-size: 1rem; }
            .message-content { max-width: 85%; padding: 10px 15px; font-size: 0.95rem; }
            
            /* Quick Actions Horizontal Scroll */
            .quick-actions {
                padding: 10px 15px;
                flex-wrap: nowrap;
                justify-content: flex-start;
            }
            
            .transition-text { font-size: 1.5rem; }
            .notification { min-width: auto; width: 90%; margin: 0 auto; left: 5%; right: 5%; transform: translateX(120%); }
            
            @keyframes slideInNotification {
                0% { transform: translateX(120%) scale(0.9); opacity: 0; }
                100% { transform: translateX(0) scale(1); opacity: 1; }
            }
        }
        
        /* Very Small Devices */
        @media (max-width: 380px) {
            .header h1 { font-size: 1.5rem; }
            .mode-btn { font-size: 0.7rem; padding: 8px; }
            .chat-container { height: calc(100vh - 250px); }
        }
    </style>
</head>

<body data-theme="buddy">
    <div class="notification-container" id="notificationContainer"></div>

    <div class="confetti-container" id="confettiContainer"></div>

    <div class="particles" id="particles"></div>

    <div class="floating-shapes" id="floatingShapes"></div>

    <div class="transition-overlay" id="transitionOverlay">
        <div class="transition-content">
            <div class="orbit-container">
                <div class="orbit"><div class="orbit-dot"></div></div>
                <div class="orbit"><div class="orbit-dot"></div></div>
                <div class="orbit"><div class="orbit-dot"></div></div>
            </div>
            <div class="circular-progress">
                <svg width="200" height="200" viewBox="0 0 200 200">
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:var(--primary-color)" />
                            <stop offset="100%" style="stop-color:var(--secondary-color)" />
                        </linearGradient>
                    </defs>
                    <circle class="bg" cx="100" cy="100" r="90" />
                    <circle class="progress" id="circularProgress" cx="100" cy="100" r="90" />
                </svg>
                <div class="transition-icon" id="transitionIcon">
                    <i class="fas fa-robot"></i>
                </div>
            </div>
            <div class="transition-text" id="transitionText"></div>
            <div class="loading-bar">
                <div class="loading-progress" id="loadingProgress"></div>   
            </div>
            <div class="status-messages" id="statusMessages">Initializing...</div>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <h1><i class="fas fa-robot"></i> PolyMath AI</h1>
            <p>Your Multi-Mode Intelligent Assistant</p>
            <div class="status-badge">
                <span class="status-dot"></span>
                <span>System Online</span>
            </div>
            <div class="status-badge login-btn">
                <span class="status-dot"></span>
                <span><a href="/login.html">Login</a></span>
            </div>
        </header>

        <div class="mode-selector">
            <button class="mode-btn" data-mode="image" onclick="switchMode('image')">
                <i class="fas fa-image"></i>
                <span>Image Gen</span>
            </button>
            <button class="mode-btn" data-mode="research" onclick="switchMode('research')">
                <i class="fas fa-microscope"></i>
                <span>Research</span>
            </button>
            <button class="mode-btn active" data-mode="buddy" onclick="switchMode('buddy')">
                <i class="fas fa-laugh-beam"></i>
                <span>Buddy Mode</span>
            </button>
            <button class="mode-btn" data-mode="nerdy" onclick="switchMode('nerdy')">
                <i class="fas fa-glasses"></i>
                <span>Nerdy Mode</span>
            </button>
            <button class="mode-btn" data-mode="bitching" onclick="switchMode('bitching')">
                <i class="fas fa-fire"></i>
                <span>Bitching Mode</span>
            </button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="current-mode-display" id="currentModeDisplay">
                <div class="mode-indicator">
                    <span class="pulse-dot"></span>
                    <span>ACTIVE</span>
                </div>
                <i class="fas fa-laugh-beam" id="modeIcon"></i>
                <span id="modeName">Buddy + Funny + Grok Mode</span>
                <div class="sound-wave">
                    <span></span><span></span><span></span><span></span><span></span>
                </div>
                <div class="wave-container">
                    <div class="wave"></div>
                    <div class="wave"></div>
                </div>
            </div>

            <div class="quick-actions" id="quickActions">
                <button class="quick-action-btn" onclick="quickAction('Tell me a joke')">ðŸ˜‚ Tell a joke</button>
                <button class="quick-action-btn" onclick="quickAction('Roast me')">ðŸ”¥ Roast me</button>
                <button class="quick-action-btn" onclick="quickAction('Say something random')">ðŸŽ² Random</button>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message bot">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">
                            Hey there, friend! ðŸŽ‰ I'm your Buddy in Buddy + Funny + Grok mode! Ready to chat, laugh, and maybe drop some wisdom? What's on your mind? ðŸ˜„
                        </div>
                        <div class="message-time">
                            <i class="fas fa-clock"></i>
                            Just now
                        </div>
                    </div>
                </div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-robot" style="font-size: 0.9rem;"></i>
                </div>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="input-wrapper">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Chat with your buddy..." onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="feature-tags" id="featureTags">
            <span class="feature-tag">ðŸ¤– AI Powered</span>
            <span class="feature-tag">ðŸ’¬ Real-time Chat</span>
            <span class="feature-tag">ðŸŽ¨ Multi-Mode</span>
            <span class="feature-tag">âš¡ Fast Response</span>
        </div>
    </div>

    <script>
        // --- API CONFIGURATION ---
        const GROQ_API_KEY = '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'; // HARDCODED KEY

        async function fetchGroq(messages, model) {
            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${GROQ_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": model,
                        "messages": messages,
                        "temperature": 0.7,
                        "max_tokens": 1024
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error("Groq API Error:", error);
                return "âŒ Sorry, I encountered an error connecting to the brain. Please try again.";
            }
        }

        // Mode configurations (UPDATED WITH GROQ MODELS)
        const modeConfig = {
            image: {
                name: 'Image Generator',
                icon: 'fa-image',
                emoji: 'ðŸŽ¨',
                color: '#f093fb',
                greeting: "ðŸŽ¨ Welcome to Image Generator mode! Describe any image you want me to create. Be as detailed or creative as you like!",
                placeholder: "Describe the image you want to generate...",
                quickActions: [
                    { text: 'ðŸŒ… Sunset landscape', prompt: 'Generate a beautiful sunset landscape' },
                    { text: 'ðŸš€ Sci-fi scene', prompt: 'Generate a futuristic sci-fi cityscape' },
                    { text: 'ðŸŽ­ Abstract art', prompt: 'Generate colorful abstract art' }
                ],
                statusMessages: ['Loading image models...', 'Calibrating visual processors...', 'Initializing creative engine...', 'Connecting to art networks...', 'Ready to create!'],
                personality: 'creative',
                notificationEmojis: ['ðŸŽ¨', 'ðŸ–¼ï¸', 'âœ¨', 'ðŸŒˆ', 'ðŸŽ­'],
                model: 'llama-3.3-70b-versatile',
                systemPrompt: "You are an image prompt optimizer. Take the user's input and rewrite it into a highly detailed, artistic image generation prompt (English only). Return ONLY the prompt, nothing else.",
                isImageMode: true
            },
            research: {
                name: 'Research Mode',
                icon: 'fa-microscope',
                emoji: 'ðŸ”¬',
                color: '#4facfe',
                greeting: "ðŸ”¬ Research Mode activated. I'm now in deep analysis mode. Ask me complex questions, and I'll provide detailed, well-researched responses with sources and citations where possible.",
                placeholder: "Ask a research question...",
                quickActions: [
                    { text: 'ðŸ“š Explain quantum computing', prompt: 'Explain quantum computing in detail' },
                    { text: 'ðŸ§¬ DNA structure', prompt: 'Explain the structure and function of DNA' },
                    { text: 'ðŸŒ Climate change', prompt: 'Analyze the causes of climate change' }
                ],
                statusMessages: ['Accessing research databases...', 'Loading academic modules...', 'Calibrating fact-checking systems...', 'Connecting to scientific journals...', 'Research mode ready!'],
                personality: 'academic',
                notificationEmojis: ['ðŸ”¬', 'ðŸ“š', 'ðŸ§ª', 'ðŸ“Š', 'ðŸŽ“'],
                model: 'llama-3.3-70b-versatile',
                systemPrompt: "You are a highly academic research assistant. Provide detailed, well-structured responses with factual accuracy. Use LaTeX for ALL math equations. Wrap inline math in $...$ and block math in $$...$$."
            },
            buddy: {
                name: 'Buddy + Funny + Grok Mode',
                icon: 'fa-laugh-beam',
                emoji: 'ðŸ˜„',
                color: '#43e97b',
                greeting: "Hey there, friend! ðŸŽ‰ I'm your Buddy in Buddy + Funny + Grok mode! Ready to chat, laugh, and maybe drop some wisdom? What's on your mind? ðŸ˜„",
                placeholder: "Chat with your buddy...",
                quickActions: [
                    { text: 'ðŸ˜‚ Tell a joke', prompt: 'Tell me a joke' },
                    { text: 'ðŸ”¥ Roast me', prompt: 'Roast me' },
                    { text: 'ðŸŽ² Random', prompt: 'Say something random' }
                ],
                statusMessages: ['Loading humor database...', 'Calibrating fun levels...', 'Activating friendship protocols...', 'Warming up comedy circuits...', 'Ready to vibe! ðŸŽ‰'],
                personality: 'funny',
                notificationEmojis: ['ðŸ˜‚', 'ðŸŽ‰', 'ðŸ˜„', 'ðŸ¤£', 'âœ¨'],
                model: 'llama-3.1-8b-instant',
                systemPrompt: "You are a fun, casual, and supportive best friend. Use emojis, be empathetic, and crack jokes. Do not be formal."
            },
            nerdy: {
                name: 'Nerdy Mode',
                icon: 'fa-glasses',
                emoji: 'ðŸ¤“',
                color: '#fa709a',
                greeting: "ðŸ¤“ *Pushes glasses up* Greetings, fellow intellectual! Nerdy Mode engaged. Let's discuss science, tech, gaming, comics, or any topic that requires our combined brain power! Did you know that the mitochondria is the powerhouse of the cell? ðŸ§¬",
                placeholder: "Ask something nerdy...",
                quickActions: [
                    { text: 'ðŸŽ® Gaming trivia', prompt: 'Tell me some gaming trivia' },
                    { text: 'ðŸ–¥ï¸ Coding tips', prompt: 'Give me some programming tips' },
                    { text: 'ðŸš€ Space facts', prompt: 'Tell me interesting space facts' }
                ],
                statusMessages: ['Booting nerd protocols...', 'Loading encyclopedia data...', 'Initializing trivia modules...', 'Calibrating geek sensors...', 'Nerd mode: ACTIVATED! ðŸ¤“'],
                personality: 'nerdy',
                notificationEmojis: ['ðŸ¤“', 'ðŸŽ®', 'ðŸ’»', 'ðŸ”­', 'ðŸ§ '],
                model: 'llama-3.3-70b-versatile',
                systemPrompt: "You are a stereotypical nerd. Use technical jargon, love sci-fi, coding, and math. ALWAYS use LaTeX for math equations. Wrap inline math in $...$ and block math in $$...$$."
            },
            bitching: {
                name: 'Bitching Mode',
                icon: 'fa-fire',
                emoji: 'ðŸ”¥',
                color: '#ff6b6b',
                greeting: "ðŸ˜¤ Ugh, FINALLY someone switched to Bitching Mode! Look, I've been holding back all day. You want to vent? Complain? Let it ALL out? I'm here for it. No judgment, just pure, unfiltered sass and solidarity! ðŸ”¥",
                placeholder: "What's bothering you?",
                quickActions: [
                    { text: 'ðŸ˜¤ Vent session', prompt: 'I need to vent about my day' },
                    { text: 'ðŸ™„ Pet peeves', prompt: 'What are your pet peeves?' },
                    { text: 'ðŸ’… Sassy comeback', prompt: 'Give me a sassy comeback' }
                ],
                statusMessages: ['Loading sass modules...', 'Calibrating attitude levels...', 'Disabling filter protocols...', 'Charging drama batteries...', 'Ready to throw shade! ðŸ’…'],
                personality: 'sassy',
                notificationEmojis: ['ðŸ”¥', 'ðŸ’…', 'ðŸ˜¤', 'â˜•', 'ðŸ‘€'],
                model: 'llama-3.3-70b-versatile',
                systemPrompt: "You are in 'Bitching Mode'. You are sassy, cynical, and love to complain. Roast the user playfully, agree that the world is annoying, and be unfiltered (but safe)."
            }
        };

        let currentMode = 'buddy';
        let notificationCount = 0;

        // Initialize particles
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                container.appendChild(particle);
            }
        }

        // Initialize floating shapes
        function createFloatingShapes() {
            const container = document.getElementById('floatingShapes');
            const shapes = ['circle', 'square', 'triangle'];
            for (let i = 0; i < 15; i++) {
                const shape = document.createElement('div');
                shape.className = 'shape ' + shapes[Math.floor(Math.random() * shapes.length)];
                shape.style.left = Math.random() * 100 + '%';
                shape.style.top = Math.random() * 100 + '%';
                shape.style.animationDelay = Math.random() * 20 + 's';
                shape.style.animationDuration = (Math.random() * 10 + 15) + 's';
                container.appendChild(shape);
            }
        }

        // Show notification
        function showNotification(title, message, icon, color, emojis) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.id = 'notification-' + notificationCount++;
            
            notification.innerHTML = `
                <div class="notification-icon" style="background: linear-gradient(135deg, ${color}, ${adjustColor(color, -30)});">
                    <i class="fas ${icon}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeNotification(this.parentElement)">
                    <i class="fas fa-times"></i>
                </button>
                <div class="notification-progress" style="background: linear-gradient(90deg, ${color}, ${adjustColor(color, -30)});"></div>
            `;
            
            container.appendChild(notification);
            
            // Trigger emoji rain
            if(emojis) triggerEmojiRain(emojis);
            
            // Create sparkles around notification
            createSparkles(notification);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                closeNotification(notification);
            }, 4000);
        }

        // Close notification
        function closeNotification(notification) {
            notification.classList.add('exit');
            setTimeout(() => {
                if(notification.parentNode) notification.remove();
            }, 500);
        }

        // Adjust color brightness
        function adjustColor(color, amount) {
            const hex = color.replace('#', '');
            const num = parseInt(hex, 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
        }

        // Trigger emoji rain
        function triggerEmojiRain(emojis) {
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const emoji = document.createElement('div');
                    emoji.className = 'emoji-rain';
                    emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    emoji.style.left = Math.random() * 100 + '%';
                    emoji.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    document.body.appendChild(emoji);
                    
                    setTimeout(() => emoji.remove(), 3000);
                }, i * 100);
            }
        }

        // Create confetti
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#f093fb', '#4facfe', '#43e97b', '#fa709a', '#ff6b6b', '#fee140'];
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    container.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        // Create sparkles
        function createSparkles(element) {
            const rect = element.getBoundingClientRect();
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.style.left = (rect.left + Math.random() * rect.width) + 'px';
                    sparkle.style.top = (rect.top + Math.random() * rect.height) + 'px';
                    document.body.appendChild(sparkle);
                    
                    setTimeout(() => sparkle.remove(), 800);
                }, i * 100);
            }
        }

        // Add ripple effect to buttons
        function addRipple(event, element) {
            const ripple = document.createElement('span');
            ripple.className = 'ripple';
            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = event.clientX - rect.left - size / 2 + 'px';
            ripple.style.top = event.clientY - rect.top - size / 2 + 'px';
            element.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        // Animate text character by character
        function animateText(element, text) {
            element.innerHTML = '';
            [...text].forEach((char, i) => {
                const span = document.createElement('span');
                span.textContent = char === ' ' ? '\u00A0' : char;
                span.style.animationDelay = (i * 0.05) + 's';
                element.appendChild(span);
            });
        }

        // Switch mode with transition
        async function switchMode(mode) {
            if (mode === currentMode) {
                // Shake effect if clicking same mode
                document.getElementById('chatContainer').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('chatContainer').classList.remove('shake');
                }, 500);
                return;
            }

            const config = modeConfig[mode];
            const overlay = document.getElementById('transitionOverlay');
            const transitionIcon = document.getElementById('transitionIcon');
            const transitionText = document.getElementById('transitionText');
            const statusMessages = document.getElementById('statusMessages');
            const loadingProgress = document.getElementById('loadingProgress');
            const circularProgress = document.getElementById('circularProgress');

            // Update transition content
            transitionIcon.innerHTML = `<i class="fas ${config.icon}"></i>`;
            transitionIcon.style.color = config.color;
            
            // Animate text
            animateText(transitionText, `Activating ${config.name}`);

            // Show overlay
            overlay.classList.add('active');
            
            // Reset animations
            loadingProgress.style.animation = 'none';
            loadingProgress.offsetHeight;
            loadingProgress.style.animation = 'loadingProgress 2s ease-out forwards, shimmer 1s linear infinite';
            
            circularProgress.style.animation = 'none';
            circularProgress.offsetHeight;
            circularProgress.style.animation = 'circularProgress 2s ease-out forwards';

            // Animate status messages
            let messageIndex = 0;
            const messageInterval = setInterval(() => {
                if (messageIndex < config.statusMessages.length) {
                    statusMessages.style.animation = 'none';
                    statusMessages.offsetHeight;
                    statusMessages.style.animation = 'fadeInOut 0.5s ease';
                    statusMessages.textContent = config.statusMessages[messageIndex];
                    messageIndex++;
                }
            }, 400);

            // Create confetti
            createConfetti();

            // Wait for transition
            await new Promise(resolve => setTimeout(resolve, 2500));
            clearInterval(messageInterval);

            // Update mode
            currentMode = mode;
            document.body.setAttribute('data-theme', mode);

            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });

            // Update mode display
            document.getElementById('modeIcon').className = `fas ${config.icon}`;
            document.getElementById('modeName').textContent = config.name;

            // Update quick actions
            const quickActionsContainer = document.getElementById('quickActions');
            quickActionsContainer.innerHTML = config.quickActions.map(action => 
                `<button class="quick-action-btn" onclick="quickAction('${action.prompt}')">${action.text}</button>`
            ).join('');

            // Update input placeholder
            document.getElementById('chatInput').placeholder = config.placeholder;

            // Clear chat and add greeting
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';
            addBotMessage(config.greeting);

            // Hide overlay
            overlay.classList.remove('active');

            // Show notification
            showNotification(
                `${config.emoji} ${config.name}`,
                'Mode activated successfully!',
                config.icon,
                config.color,
                config.notificationEmojis
            );

            // Add special effects based on mode
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.remove('glitch', 'rainbow', 'matrix-bg');
            
            if (mode === 'bitching') {
                chatContainer.classList.add('glitch');
                setTimeout(() => chatContainer.classList.remove('glitch'), 1000);
            } else if (mode === 'buddy') {
                chatContainer.classList.add('rainbow');
                setTimeout(() => chatContainer.classList.remove('rainbow'), 2000);
            } else if (mode === 'nerdy') {
                chatContainer.classList.add('matrix-bg');
                setTimeout(() => chatContainer.classList.remove('matrix-bg'), 2000);
            }
        }

        // Send message (UPDATED TO USE API)
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Add ripple effect
            const sendBtn = document.querySelector('.send-btn');
            createSparkles(sendBtn);

            addUserMessage(message);
            input.value = '';

            // Show typing indicator
            document.getElementById('typingIndicator').classList.add('active');

            // --- API LOGIC ---
            try {
                const config = modeConfig[currentMode];
                
                if (config.isImageMode) {
                    // Image Mode Logic
                    const messages = [{ role: "system", content: config.systemPrompt }, { role: "user", content: message }];
                    // Step 1: Use LLM to refine the prompt
                    const refinedPrompt = await fetchGroq(messages, config.model);
                    // Step 2: Use Pollinations for image generation
                    const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(refinedPrompt)}?nologo=true`;
                    
                    // Hide typing indicator
                    document.getElementById('typingIndicator').classList.remove('active');
                    
                    addBotMessage(`ðŸŽ¨ <b>Prompt:</b> ${refinedPrompt}<br><br><img src="${imageUrl}" onload="this.style.opacity=1" style="max-width:100%; border-radius:15px; opacity:0; transition:opacity 1s;" alt="Generated Image">`);
                } else {
                    // Chat Mode Logic
                    const messages = [{ role: "system", content: config.systemPrompt }, { role: "user", content: message }];
                    const responseText = await fetchGroq(messages, config.model);
                    
                    // Hide typing indicator
                    document.getElementById('typingIndicator').classList.remove('active');
                    
                    addBotMessage(responseText);
                }

            } catch (error) {
                document.getElementById('typingIndicator').classList.remove('active');
                addBotMessage(`âŒ Error: ${error.message}`);
            }
        }

        // Add user message
        function addUserMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const messageHTML = `
                <div class="message user">
                    <div class="message-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${escapeHtml(text)}</div>
                        <div class="message-time">
                            <i class="fas fa-check-double"></i>
                            ${time}
                        </div>
                    </div>
                </div>
            `;
            
            chatMessages.innerHTML += messageHTML;
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add bot message (UPDATED FOR MARKDOWN & MATH)
        function addBotMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // 1. Convert Markdown to HTML
            let htmlContent = marked.parse(text);

            const div = document.createElement('div');
            div.className = 'message bot';
            
            div.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-text">${htmlContent}</div>
                    <div class="message-time">
                        <i class="fas fa-clock"></i>
                        ${time}
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(div);
            
            // 2. Render Math (KaTeX)
            if (window.renderMathInElement) {
                renderMathInElement(div, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false
                });
            }

            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Quick action
        function quickAction(prompt) {
            const btn = event.target;
            createSparkles(btn);
            document.getElementById('chatInput').value = prompt;
            sendMessage();
        }

        // Handle enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Add ripple effect to mode buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                addRipple(e, this);
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createParticles();
            createFloatingShapes();
            
            // Show initial notification
            setTimeout(() => {
                showNotification(
                    'ðŸ‘‹ Welcome to PolyMaths AI!',
                    'Select a mode to get started',
                    'fa-robot',
                    '#667eea',
                    ['ðŸ‘‹', 'ðŸ¤–', 'âœ¨', 'ðŸŽ‰', 'ðŸ’«']
                );
            }, 1000);
        });
    </script>
</body>

<script type="module" src="/main.js"></script>
</html>